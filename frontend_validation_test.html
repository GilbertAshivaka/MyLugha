<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyLugha Frontend Integration Test - Post Database Population</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .validation-item {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üß™ MyLugha Frontend Integration Test - Database Populated</h1>
    <p>Testing the frontend integration after populating the database with test data.</p>
    
    <div class="test-section">
        <h2>üìä Database Status Summary</h2>
        <div id="dbStatus">Checking database status...</div>
        <button class="btn" onclick="checkDatabaseStatus()">Refresh Database Status</button>
    </div>

    <div class="test-section">
        <h2>üîê Authentication Test</h2>
        <div id="authStatus">Not logged in</div>
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="username" value="testuser123" placeholder="Username">
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" value="testuser123@example.com" placeholder="Email">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="password" value="testpass123" placeholder="Password">
        </div>
        <button class="btn" onclick="login()">Login</button>
        <button class="btn" onclick="logout()">Logout</button>
    </div>

    <div class="test-section">
        <h2>‚úÖ Load Items for Validation</h2>
        <div id="validationStatus">Click button to load validation items</div>
        <button class="btn" onclick="loadValidationItems()" id="loadValidationBtn">Load Validation Items</button>
        <div id="validationItems"></div>
    </div>

    <div class="test-section">
        <h2>üìù Test Contribution Submission</h2>
        <div class="form-group">
            <label>Language:</label>
            <select id="contributionLanguage">
                <option value="">Select Language</option>
                <option value="sw">Kiswahili</option>
                <option value="kik">Gikuyu</option>
                <option value="luo">Dholuo</option>
            </select>
        </div>
        <div class="form-group">
            <label>Content Type:</label>
            <select id="contributionContentType">
                <option value="word">Word</option>
                <option value="sentence">Sentence</option>
                <option value="paragraph">Paragraph</option>
            </select>
        </div>
        <div class="form-group">
            <label>Original Text (English):</label>
            <input type="text" id="originalText" placeholder="Enter English text">
        </div>
        <div class="form-group">
            <label>Translated Text:</label>
            <input type="text" id="translatedText" placeholder="Enter translation">
        </div>
        <div class="form-group">
            <label>Context (optional):</label>
            <textarea id="context" placeholder="Provide context for the translation"></textarea>
        </div>
        <button class="btn" onclick="submitContribution()" id="submitBtn">Submit Contribution</button>
        <div id="contributionResult"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Test Validation Submission</h2>
        <div id="validationTestArea">
            <p>Select an item from "Load Items for Validation" section above to test validation submission.</p>
        </div>
    </div>

    <div class="test-section">
        <h2>üìã API Logs</h2>
        <button class="btn" onclick="clearLogs()">Clear Logs</button>
        <pre id="apiLogs"></pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let authToken = '';
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            document.getElementById('apiLogs').textContent = logs.join('\n');
            console.log(logEntry);
        }

        function clearLogs() {
            logs = [];
            document.getElementById('apiLogs').textContent = '';
        }

        async function makeRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            log(`Making ${finalOptions.method || 'GET'} request to ${url}`);
            
            try {
                const response = await fetch(url, finalOptions);
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Success: ${response.status} ${response.statusText}`, 'success');
                    return { success: true, data, status: response.status };
                } else {
                    log(`‚ùå Error: ${response.status} ${response.statusText} - ${JSON.stringify(data)}`, 'error');
                    return { success: false, data, status: response.status };
                }
            } catch (error) {
                log(`üí• Request failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function checkDatabaseStatus() {
            const statusDiv = document.getElementById('dbStatus');
            statusDiv.innerHTML = 'Checking database status...';
            
            try {
                // Check contributions
                const contribResponse = await makeRequest(`${API_BASE}/contributions/`);
                
                // Check validations  
                const validationResponse = await makeRequest(`${API_BASE}/validations/`);
                
                // Check languages
                const languageResponse = await makeRequest(`${API_BASE}/languages/`);
                
                if (contribResponse.success && validationResponse.success && languageResponse.success) {
                    const contribCount = contribResponse.data.count || 0;
                    const validationCount = validationResponse.data.count || 0;
                    const languageCount = languageResponse.data.count || 0;
                    
                    statusDiv.innerHTML = \`
                        <div class="success">
                            <h4>‚úÖ Database is populated!</h4>
                            <ul>
                                <li><strong>Languages:</strong> \${languageCount} available</li>
                                <li><strong>Contributions:</strong> \${contribCount} total</li>
                                <li><strong>Validations:</strong> \${validationCount} completed</li>
                            </ul>
                            ${contribCount > 0 ? '<p>üéâ Great! The database now has content for testing validation functionality.</p>' : '<p>‚ö†Ô∏è No contributions found - validation testing will be limited.</p>'}
                        </div>
                    \`;
                } else {
                    statusDiv.innerHTML = '<div class="error">‚ùå Failed to check database status</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = \`<div class="error">‚ùå Error: \${error.message}</div>\`;
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            const response = await makeRequest(`${API_BASE}/token/`, {
                method: 'POST',
                body: JSON.stringify({ username, email, password })
            });

            const statusDiv = document.getElementById('authStatus');
            if (response.success) {
                authToken = response.data.access;
                statusDiv.innerHTML = \`<div class="success">‚úÖ Logged in as \${username}</div>\`;
                document.getElementById('loadValidationBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            } else {
                statusDiv.innerHTML = \`<div class="error">‚ùå Login failed: \${response.data?.detail || 'Unknown error'}</div>\`;
            }
        }

        function logout() {
            authToken = '';
            document.getElementById('authStatus').innerHTML = '<div class="info">Logged out</div>';
            document.getElementById('loadValidationBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
        }

        async function loadValidationItems() {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            const statusDiv = document.getElementById('validationStatus');
            const itemsDiv = document.getElementById('validationItems');
            
            statusDiv.innerHTML = 'Loading validation items...';
            itemsDiv.innerHTML = '';

            // Load contributions that need validation (pending status)
            const response = await makeRequest(`${API_BASE}/contributions/?status=pending`);
            
            if (response.success) {
                const contributions = response.data.results || [];
                
                if (contributions.length === 0) {
                    // If no pending items, load any items for demonstration
                    const allResponse = await makeRequest(`${API_BASE}/contributions/`);
                    if (allResponse.success) {
                        const allContributions = allResponse.data.results || [];
                        statusDiv.innerHTML = \`<div class="info">‚ÑπÔ∏è No pending items found. Showing all \${allContributions.length} contributions for testing purposes.</div>\`;
                        displayValidationItems(allContributions.slice(0, 5)); // Show first 5
                    } else {
                        statusDiv.innerHTML = '<div class="error">‚ùå Failed to load validation items</div>';
                    }
                } else {
                    statusDiv.innerHTML = \`<div class="success">‚úÖ Loaded \${contributions.length} items ready for validation</div>\`;
                    displayValidationItems(contributions);
                }
            } else {
                statusDiv.innerHTML = '<div class="error">‚ùå Failed to load validation items</div>';
            }
        }

        function displayValidationItems(contributions) {
            const itemsDiv = document.getElementById('validationItems');
            
            if (contributions.length === 0) {
                itemsDiv.innerHTML = '<p>No items available for validation.</p>';
                return;
            }

            itemsDiv.innerHTML = contributions.map(contrib => \`
                <div class="validation-item">
                    <h4>\${contrib.content_type} in \${contrib.language_name}</h4>
                    <p><strong>Original:</strong> \${contrib.original_text}</p>
                    <p><strong>Translation:</strong> \${contrib.translated_text}</p>
                    <p><strong>Status:</strong> \${contrib.status}</p>
                    <p><strong>Validations:</strong> \${contrib.positive_validations}/\${contrib.validations_count}</p>
                    <div>
                        <button class="btn" onclick="validateContribution('\${contrib.id}', true)">‚úÖ Mark Valid</button>
                        <button class="btn" onclick="validateContribution('\${contrib.id}', false)">‚ùå Mark Invalid</button>
                    </div>
                    <div id="validation-result-\${contrib.id}"></div>
                </div>
            \`).join('');
        }

        async function validateContribution(contributionId, isValid) {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            const resultDiv = document.getElementById(\`validation-result-\${contributionId}\`);
            resultDiv.innerHTML = 'Submitting validation...';

            const response = await makeRequest(`${API_BASE}/validations/`, {
                method: 'POST',
                body: JSON.stringify({
                    contribution: contributionId,
                    is_valid: isValid,
                    feedback: isValid ? 'Looks good!' : 'Needs improvement'
                })
            });

            if (response.success) {
                resultDiv.innerHTML = \`<div class="success">‚úÖ Validation submitted successfully!</div>\`;
                // Reload validation items to see updated counts
                setTimeout(() => loadValidationItems(), 1000);
            } else {
                const errorMsg = response.data?.detail || response.data?.non_field_errors?.[0] || 'Unknown error';
                resultDiv.innerHTML = \`<div class="error">‚ùå Validation failed: \${errorMsg}</div>\`;
            }
        }

        async function submitContribution() {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            const language = document.getElementById('contributionLanguage').value;
            const contentType = document.getElementById('contributionContentType').value;
            const originalText = document.getElementById('originalText').value;
            const translatedText = document.getElementById('translatedText').value;
            const context = document.getElementById('context').value;

            if (!language || !originalText || !translatedText) {
                alert('Please fill in all required fields');
                return;
            }

            const resultDiv = document.getElementById('contributionResult');
            resultDiv.innerHTML = 'Submitting contribution...';

            const response = await makeRequest(`${API_BASE}/contributions/text/`, {
                method: 'POST',
                body: JSON.stringify({
                    language: language,
                    content_type: contentType,
                    original_text: originalText,
                    translated_text: translatedText,
                    context: context,
                    anonymous: false
                })
            });

            if (response.success) {
                resultDiv.innerHTML = '<div class="success">‚úÖ Contribution submitted successfully!</div>';
                // Clear form
                document.getElementById('originalText').value = '';
                document.getElementById('translatedText').value = '';
                document.getElementById('context').value = '';
                // Refresh database status
                setTimeout(() => checkDatabaseStatus(), 1000);
            } else {
                const errorMsg = response.data?.detail || JSON.stringify(response.data);
                resultDiv.innerHTML = \`<div class="error">‚ùå Submission failed: \${errorMsg}</div>\`;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkDatabaseStatus();
            // Disable buttons that require authentication
            document.getElementById('loadValidationBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
        });
    </script>
</body>
</html>
