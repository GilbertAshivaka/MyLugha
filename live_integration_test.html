<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyLugha Live Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        .form-group { margin: 10px 0; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó MyLugha Frontend-Backend Integration Test</h1>
        <p><strong>Frontend:</strong> http://localhost:3002 | <strong>Backend:</strong> http://localhost:8080</p>

        <!-- API Connectivity Test -->
        <div class="test-section" id="connectivity-test">
            <h2>1. API Connectivity Test</h2>
            <button onclick="testConnectivity()">Test Backend Connection</button>
            <div id="connectivity-result"></div>
        </div>

        <!-- Authentication Test -->
        <div class="test-section" id="auth-test">
            <h2>2. Authentication Flow Test</h2>
            <div class="form-group">
                <input type="text" id="test-username" placeholder="Test Username" value="testuser123">
                <input type="email" id="test-email" placeholder="Test Email" value="test@example.com">
                <input type="password" id="test-password" placeholder="Test Password" value="testpass123">
            </div>
            <button onclick="testRegistration()">Test Registration</button>
            <button onclick="testLogin()">Test Login</button>
            <div id="auth-result"></div>
        </div>

        <!-- Data Endpoints Test -->
        <div class="test-section" id="data-test">
            <h2>3. Data Endpoints Test</h2>
            <button onclick="testLanguagesEndpoint()">Test Languages API</button>
            <button onclick="testContributionsEndpoint()">Test Contributions API</button>
            <div id="data-result"></div>
        </div>

        <!-- CORS Test -->
        <div class="test-section" id="cors-test">
            <h2>4. CORS Configuration Test</h2>
            <button onclick="testCORS()">Test CORS Headers</button>
            <div id="cors-result"></div>
        </div>

        <!-- Frontend Components Test -->
        <div class="test-section" id="frontend-test">
            <h2>5. Frontend Component Test</h2>
            <button onclick="testFrontendAPI()">Test Frontend API Service</button>
            <div id="frontend-result"></div>
        </div>

        <!-- Live Application Test -->
        <div class="test-section" id="live-test">
            <h2>6. Live Application Navigation</h2>
            <button onclick="openFrontend()">Open Main Application</button>
            <button onclick="openLoginPage()">Open Login Page</button>
            <div id="live-result"></div>
        </div>

        <!-- Test Log -->
        <div class="test-section">
            <h2>üìã Test Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        const FRONTEND_BASE = 'http://localhost:3002';
        let authToken = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }

        function updateResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `test-section ${type}`;
        }

        async function testConnectivity() {
            log('Testing API connectivity...');
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                if (response.ok) {
                    updateResult('connectivity-result', `‚úÖ Backend Connected Successfully!<br>Version: ${data.version}<br>Available endpoints: ${Object.keys(data.endpoints).length}`, 'success');
                    log('Backend connectivity test passed');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateResult('connectivity-result', `‚ùå Connection Failed: ${error.message}`, 'error');
                log(`Backend connectivity test failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testRegistration() {
            const username = document.getElementById('test-username').value;
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            log(`Testing registration for user: ${username}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/register/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    updateResult('auth-result', `‚úÖ Registration Successful!<br>User: ${data.username || username}`, 'success');
                    log('Registration test passed');
                } else {
                    // Registration might fail if user already exists, which is okay for testing
                    updateResult('auth-result', `‚ö†Ô∏è Registration Response: ${response.status}<br>Message: ${data.message || JSON.stringify(data)}`, 'info');
                    log(`Registration returned ${response.status}: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                updateResult('auth-result', `‚ùå Registration Failed: ${error.message}`, 'error');
                log(`Registration test failed: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;

            log(`Testing login for user: ${username}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.access) {
                    authToken = data.access;
                    updateResult('auth-result', `‚úÖ Login Successful!<br>Token received: ${data.access.substring(0, 20)}...`, 'success');
                    log('Login test passed, token stored');
                } else {
                    updateResult('auth-result', `‚ùå Login Failed: ${data.message || data.detail || 'Invalid credentials'}`, 'error');
                    log(`Login test failed: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                updateResult('auth-result', `‚ùå Login Error: ${error.message}`, 'error');
                log(`Login test error: ${error.message}`, 'error');
            }
        }

        async function testLanguagesEndpoint() {
            log('Testing languages endpoint...');
            
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}/languages/`, {
                    headers: headers
                });

                const data = await response.json();
                
                if (response.ok) {
                    const count = Array.isArray(data) ? data.length : (data.count || 'Unknown');
                    updateResult('data-result', `‚úÖ Languages API Working!<br>Retrieved: ${count} languages`, 'success');
                    log(`Languages endpoint test passed: ${count} languages found`);
                } else {
                    updateResult('data-result', `‚ö†Ô∏è Languages API Response: ${response.status}<br>${JSON.stringify(data)}`, 'info');
                    log(`Languages endpoint returned ${response.status}: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                updateResult('data-result', `‚ùå Languages API Error: ${error.message}`, 'error');
                log(`Languages endpoint test failed: ${error.message}`, 'error');
            }
        }

        async function testContributionsEndpoint() {
            log('Testing contributions endpoint...');
            
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}/contributions/`, {
                    headers: headers
                });

                const data = await response.json();
                
                if (response.ok) {
                    const count = Array.isArray(data) ? data.length : (data.count || 'Unknown');
                    updateResult('data-result', document.getElementById('data-result').innerHTML + `<br>‚úÖ Contributions API Working!<br>Retrieved: ${count} contributions`, 'success');
                    log(`Contributions endpoint test passed: ${count} contributions found`);
                } else {
                    updateResult('data-result', document.getElementById('data-result').innerHTML + `<br>‚ö†Ô∏è Contributions API Response: ${response.status}<br>${JSON.stringify(data)}`, 'info');
                    log(`Contributions endpoint returned ${response.status}: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                updateResult('data-result', document.getElementById('data-result').innerHTML + `<br>‚ùå Contributions API Error: ${error.message}`, 'error');
                log(`Contributions endpoint test failed: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            log('Testing CORS configuration...');
            
            try {
                const response = await fetch(`${API_BASE}/`, {
                    method: 'OPTIONS'
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                if (corsHeaders['Access-Control-Allow-Origin']) {
                    updateResult('cors-result', `‚úÖ CORS Configured!<br>Origin: ${corsHeaders['Access-Control-Allow-Origin']}<br>Methods: ${corsHeaders['Access-Control-Allow-Methods']}<br>Headers: ${corsHeaders['Access-Control-Allow-Headers']}`, 'success');
                    log('CORS test passed - headers present');
                } else {
                    updateResult('cors-result', `‚ö†Ô∏è CORS headers not found in response`, 'info');
                    log('CORS test - no explicit headers found');
                }
            } catch (error) {
                updateResult('cors-result', `‚ùå CORS Test Error: ${error.message}`, 'error');
                log(`CORS test failed: ${error.message}`, 'error');
            }
        }

        async function testFrontendAPI() {
            log('Testing frontend API service integration...');
            
            try {
                // Test if we can access the frontend and its API service
                const frontendResponse = await fetch(FRONTEND_BASE);
                
                if (frontendResponse.ok) {
                    updateResult('frontend-result', `‚úÖ Frontend Server Accessible!<br>Status: ${frontendResponse.status}<br>Content-Type: ${frontendResponse.headers.get('content-type')}`, 'success');
                    log('Frontend accessibility test passed');
                } else {
                    throw new Error(`Frontend server returned ${frontendResponse.status}`);
                }
            } catch (error) {
                updateResult('frontend-result', `‚ùå Frontend Test Error: ${error.message}`, 'error');
                log(`Frontend test failed: ${error.message}`, 'error');
            }
        }

        function openFrontend() {
            log('Opening main application...');
            window.open(FRONTEND_BASE, '_blank');
            updateResult('live-result', `üöÄ Main application opened in new tab`, 'info');
        }

        function openLoginPage() {
            log('Opening login page...');
            window.open(`${FRONTEND_BASE}/#/login`, '_blank');
            updateResult('live-result', `üîê Login page opened in new tab`, 'info');
        }

        function clearLog() {
            document.getElementById('test-log').textContent = '';
            log('Test log cleared');
        }

        // Auto-run connectivity test on page load
        window.addEventListener('load', () => {
            log('Live integration test page loaded');
            testConnectivity();
        });
    </script>
</body>
</html>
